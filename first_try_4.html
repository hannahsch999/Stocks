<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Live S&P 500 Estimator (jQuery Edition)</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  
  <style>
    body { font-family:'Montserrat',sans-serif; background:linear-gradient(120deg,#f8e3f0 0%,#d1e3ff 100%); color:#333; margin:0; padding:0; min-height:100vh; }
    header { padding:20px; text-align:center; background:linear-gradient(90deg,#e8a9d6 20%,#b3cfff 80%); color:#4c3273; font-size:2em; font-weight:700; letter-spacing:2px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .status-bar { background:#fff; text-align:center; padding:10px; font-size:0.9em; color:#666; border-bottom:1px solid #eee; }
    .status-ok { color:#28a745; font-weight:bold; }
    .status-err { color:#dc3545; font-weight:bold; }
    .filters { display:flex; flex-wrap:wrap; gap:14px; padding:24px; justify-content:center; background:#fff2fa; border-bottom:2px solid #f3c9e7; }
    .filter-group { display:flex; flex-direction:column; background:#fed6ff; border-radius:12px; padding:12px; min-width:180px; flex:1; max-width:250px; }
    .filter-group label { margin-bottom:6px; font-weight:bold; color:#4c3273; }
    select { border:2px solid #fff; border-radius:8px; padding:4px; background:#fff; color:#333; font-family:inherit; }
    .pink-btn { background:linear-gradient(90deg,#e8a9d6,#b3cfff); border:none; border-radius:20px; padding:12px 32px; margin:20px 0; color:#4c3273; font-weight:bold; cursor:pointer; box-shadow:2px 4px 16px #e8a9d6AA; transition:all .3s; font-size:1em; }
    .pink-btn:hover { background:linear-gradient(100deg,#f3c9e7 20%,#b3d6ff 80%); transform:translateY(-2px); box-shadow:2px 6px 20px #d1e3ff; }
    .pink-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; box-shadow:none; filter:grayscale(100%); }
    .results { max-width:1100px; margin:26px auto; padding:20px; }
    .section-title { text-align:center; color:#4c3273; margin-bottom:20px; }
    .cards { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:20px; margin-bottom:30px; }
    .stock-card { background:linear-gradient(135deg,#fff,#f8faff); border:1px solid #e8e8e8; border-radius:16px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05); transition:all .3s; position:relative; overflow:hidden; }
    .stock-card:hover { box-shadow:0 8px 24px rgba(232, 169, 214, 0.4); transform:translateY(-5px); border-color:#e8a9d6; }
    .stock-card h3 { margin:0 0 5px 0; color:#4c3273; font-size:1.1em; }
    .stock-card .ticker { font-size:0.9em; color:#888; background:#eee; padding:2px 6px; border-radius:4px; }
    .stock-meta { font-size:0.85em; color:#666; margin:10px 0; line-height:1.4; }
    .stock-badge { display:inline-block; font-size:0.75em; padding:2px 8px; border-radius:10px; margin-right:5px; margin-bottom:5px; }
    .badge-sector { background:#e0ecff; color:#4c3273; }
    footer { background:#f8e3f0; padding:20px; text-align:center; color:#807ca5; margin-top:auto; }
    .modal { display:none; position:fixed; z-index:2000; inset:0; width:100%; height:100%; justify-content:center; align-items:center; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); }
    .modal-content { background:#fff; padding:32px; border-radius:20px; width:90%; max-width:600px; position:relative; box-shadow:0 10px 40px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto; }
    .close-btn { position:absolute; top:20px; right:20px; font-size:24px; font-weight:bold; color:#e8a9d6; cursor:pointer; transition:color .2s; }
    .close-btn:hover { color:#b3cfff; }
    .loader { border:4px solid #f3f3f3; border-top:4px solid #e8a9d6; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:20px auto; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    .ai-prediction-box { background:#f0f7ff; border-left:4px solid #b3cfff; padding:15px; margin:15px 0; border-radius:0 8px 8px 0; }
    .prediction-bullish { border-left-color:#28a745; background:#eaffea; }
    .prediction-bearish { border-left-color:#dc3545; background:#ffeaea; }
  </style>
</head>
<body>

<header>AI S&P 500 Estimator</header>
<div class="status-bar" id="statusBar">Initializing System...</div>

<div class="filters">
  <div class="filter-group">
    <label for="sectorSelect">Sector</label>
    <select id="sectorSelect" multiple style="height:120px">
      <option disabled>Loading...</option>
    </select>
  </div>

  <div class="filter-group">
    <label for="subIndustrySelect">Sub-Industry</label>
    <select id="subIndustrySelect" multiple style="height:120px">
      <option disabled>Loading...</option>
    </select>
  </div>

  <div class="filter-group" style="justify-content:center; align-items:center;">
    <button class="pink-btn" id="getEstimatesBtn" disabled>Initializing...</button>
    <small style="text-align:center; color:#666;">Assets: <span id="countDisplay">0</span></small>
  </div>
</div>

<div class="results" id="resultsArea" style="display:none">
  <h2 class="section-title">AI Selected Candidates</h2>
  <div class="cards" id="cardsContainer"></div>
</div>

<div class="modal" id="stockModal">
  <div class="modal-content">
    <span class="close-btn" id="closeModalBtn">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<footer>
  Data sourced via jQuery AJAX & CORS Proxy. <br>
  Not financial advice. For educational purposes only.
</footer>

<script>
// =====================================
// APP MODULE (Modular Organization)
// =====================================
const StockApp = (function() {
  'use strict';
  
  // ===== CONFIGURATION =====
  const CONFIG = {
    proxyUrl: "https://corsproxy.io/?",
    primaryDataUrl: "https://raw.githubusercontent.com/hannahsch999/Stocks/main/sp500_complete_sample.json",
    maxResults: 20
  };
  
  // ===== STATE MANAGEMENT =====
  const state = {
    masterStockList: [],
    cachedElements: {}
  };
  
  // ===== ELEMENT CACHING (jQuery Best Practice) =====
  // Cache frequently used jQuery selectors to avoid repeated DOM queries
  function cacheElements() {
    state.cachedElements = {
      $statusBar: $('#statusBar'),
      $estimateBtn: $('#getEstimatesBtn'),
      $countDisplay: $('#countDisplay'),
      $sectorSelect: $('#sectorSelect'),
      $subIndustrySelect: $('#subIndustrySelect'),
      $resultsArea: $('#resultsArea'),
      $cardsContainer: $('#cardsContainer'),
      $modal: $('#stockModal'),
      $modalBody: $('#modalBody'),
      $closeModalBtn: $('#closeModalBtn')
    };
  }
  
  // ===== INITIALIZATION =====
  function init() {
    cacheElements();
    bindEvents();
    loadStockData();
  }
  
  // ===== EVENT BINDING (jQuery .on() method) =====
  function bindEvents() {
    const { $estimateBtn, $closeModalBtn, $modal } = state.cachedElements;
    
    // jQuery .on() for button click
    $estimateBtn.on('click', handleEstimateClick);
    
    // jQuery .on() for modal close
    $closeModalBtn.on('click', closeModal);
    
    // jQuery event delegation for window clicks (close modal when clicking outside)
    $(window).on('click', function(event) {
      if (event.target.id === 'stockModal') {
        closeModal();
      }
    });
  }
  
  // ===== DATA LOADING (jQuery AJAX) =====
  async function loadStockData() {
    const { $statusBar, $estimateBtn, $countDisplay } = state.cachedElements;
    
    try {
      console.log("Fetching stock data...");
      let rawData = [];
      
      // jQuery $.ajax() - Primary data source
      try {
        rawData = await $.ajax({
          url: CONFIG.proxyUrl + encodeURIComponent(CONFIG.primaryDataUrl),
          method: 'GET',
          dataType: 'json',
          timeout: 10000
        });
      } catch (e) {
        console.warn("Primary source failed, trying fallback...", e);
        
        // jQuery $.ajax() - Fallback data source
        rawData = await $.ajax({
          url: CONFIG.proxyUrl + encodeURIComponent(CONFIG.fallbackDataUrl),
          method: 'GET',
          dataType: 'json',
          timeout: 10000
        });
      }
      
      // Process and store data
      state.masterStockList = rawData.map(item => ({
        ticker: item.Symbol || item.symbol || item.Ticker,
        name: item.Name || item.name || item.Security,
        sector: item['GICS Sector'] || item.Sector || item.sector || 'Other',
        subsector: item['GICS Sub-Industry'] || item.subSector || item.subsector || 'Other'
      })).filter(s => s.ticker && s.sector);
      
      console.log(`Loaded ${state.masterStockList.length} stocks`);
      
      // Update UI using jQuery methods
      populateFilters();
      $countDisplay.text(state.masterStockList.length); // jQuery .text()
      $statusBar.html(`System Ready: <span class="status-ok">Connected (${state.masterStockList.length} assets)</span>`); // jQuery .html()
      $estimateBtn.prop('disabled', false).text("Get Stock Estimates"); // jQuery .prop() and chaining
      
    } catch (error) {
      console.error("Data load error:", error);
      $statusBar.html(`System Error: <span class="status-err">Connection Failed</span>`);
      $estimateBtn.text("Connection Failed");
    }
  }
  
  // ===== POPULATE FILTERS (jQuery DOM Manipulation) =====
  function populateFilters() {
    const { $sectorSelect, $subIndustrySelect } = state.cachedElements;
    
    // Use Set to get unique values
    const sectors = [...new Set(state.masterStockList.map(s => s.sector))].sort();
    const subsectors = [...new Set(state.masterStockList.map(s => s.subsector))].sort();
    
    // jQuery .empty() to clear existing options
    $sectorSelect.empty();
    $subIndustrySelect.empty();
    
    // jQuery .each() to iterate and jQuery .append() to add elements
    $.each(sectors, function(index, sector) {
      $sectorSelect.append($('<option>').val(sector).text(sector)); // jQuery chaining
    });
    
    $.each(subsectors, function(index, subsector) {
      $subIndustrySelect.append($('<option>').val(subsector).text(subsector));
    });
  }
  
  // ===== HANDLE ESTIMATE BUTTON CLICK =====
  function handleEstimateClick() {
    const { $resultsArea, $cardsContainer, $sectorSelect, $subIndustrySelect } = state.cachedElements;
    
    // jQuery .show() to display results area
    $resultsArea.show();
    
    // jQuery .html() to insert loader
    $cardsContainer.html('<div class="loader"></div>');
    
    // jQuery .val() to get multi-select values (returns array)
    const selectedSectors = $sectorSelect.val() || [];
    const selectedSubs = $subIndustrySelect.val() || [];
    
    // Filter stocks
    let matches = state.masterStockList.filter(stock => {
      const sectorMatch = selectedSectors.length === 0 || selectedSectors.includes(stock.sector);
      const subMatch = selectedSubs.length === 0 || selectedSubs.includes(stock.subsector);
      return sectorMatch && subMatch;
    });
    
    // Randomize and limit results
    matches = matches.sort(() => 0.5 - Math.random()).slice(0, CONFIG.maxResults);
    
    // jQuery .empty() to clear loader
    $cardsContainer.empty();
    
    if (matches.length === 0) {
      $cardsContainer.html('<p style="text-align:center; width:100%">No assets found matching your criteria.</p>');
      return;
    }
    
    // Render stock cards
    renderStockCards(matches);
  }
  
  // ===== RENDER STOCK CARDS (jQuery DOM Creation) =====
  function renderStockCards(stocks) {
    const { $cardsContainer } = state.cachedElements;
    
    // jQuery .each() to iterate through stocks
    $.each(stocks, function(index, stock) {
      // jQuery element creation with chaining
      const $card = $('<div>')
        .addClass('stock-card')
        .append(
          $('<h3>').text(stock.name),
          $('<span>').addClass('ticker').text(stock.ticker),
          $('<div>').addClass('stock-meta').append(
            $('<span>').addClass('stock-badge badge-sector').text(stock.sector),
            $('<br>'),
            $('<small>').text(stock.subsector)
          ),
          $('<button>')
            .addClass('pink-btn')
            .css({ 'width': '100%', 'margin': '10px 0 0 0', 'padding': '10px' }) // jQuery .css()
            .text('Run AI Prediction')
            .on('click', function() { analyzeStock(stock.ticker); }) // jQuery event binding
        );
      
      // jQuery .append() to add card to container
      $cardsContainer.append($card);
    });
  }
  
  // ===== ANALYZE STOCK (AJAX + Modal) =====
  async function analyzeStock(ticker) {
    const { $modal, $modalBody } = state.cachedElements;
    
    // jQuery .css() to set display, then .fadeIn() for animation
    $modal.css('display', 'flex').hide().fadeIn();
    
    // jQuery .html() to set loading state
    $modalBody.html(`
      <div style="text-align:center">
        <div class="loader"></div>
        <p>Fetching market data for ${ticker}...</p>
      </div>
    `);
    
    try {
      const history = await fetchStockHistory(ticker);
      const analysis = performAnalysis(history.prices);
      renderAnalysis(ticker, history, analysis);
    } catch (error) {
      $modalBody.html(`
        <h3 style="color:#dc3545">Analysis Failed</h3>
        <p>Could not retrieve data for ${ticker}.</p>
        <small>Error: ${error.message || "Unknown Error"}</small>
      `);
    }
  }
  
  // ===== FETCH STOCK HISTORY (jQuery AJAX for CSV) =====
  async function fetchStockHistory(ticker) {
    const symbol = ticker.replace('.', '-');
    const stooqUrl = `https://stooq.com/q/d/l/?s=${symbol}.US&i=d`;
    
    // jQuery $.ajax() for text/CSV data
    const csvText = await $.ajax({
      url: CONFIG.proxyUrl + encodeURIComponent(stooqUrl),
      method: 'GET',
      dataType: 'text',
      timeout: 8000
    });
    
    // Parse CSV data
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) throw new Error("No data returned");
    
    const rows = lines.slice(1).map(l => l.split(',')).filter(r => r.length > 4);
    const validRows = rows.slice(0, 100).reverse();
    
    const dates = validRows.map(r => r[0]);
    const prices = validRows.map(r => parseFloat(r[4]));
    
    if (prices.some(isNaN)) throw new Error("Corrupt data");
    
    return { dates, prices, source: 'Stooq (Public)' };
  }
  
  // ===== PERFORM TECHNICAL ANALYSIS =====
  function performAnalysis(prices) {
    if (prices.length < 20) return { sentiment: "Neutral", confidence: "Low", signal: "Hold", cssClass: "" };
    
    const current = prices[prices.length - 1];
    const sma20 = average(prices.slice(-20));
    const sma50 = prices.length >= 50 ? average(prices.slice(-50)) : sma20;
    
    let sentiment = "Neutral";
    let signal = "Hold";
    let cssClass = "";
    
    if (current > sma20 && sma20 > sma50) {
      sentiment = "Bullish";
      signal = "Strong Buy";
      cssClass = "prediction-bullish";
    } else if (current < sma20 && sma20 < sma50) {
      sentiment = "Bearish";
      signal = "Sell / Avoid";
      cssClass = "prediction-bearish";
    } else if (current > sma20) {
      sentiment = "Mild Bullish";
      signal = "Buy Dip";
      cssClass = "prediction-bullish";
    }
    
    const volatility = calculateVolatility(prices.slice(-14));
    return { current, sma20, sma50, sentiment, signal, cssClass, volatility };
  }
  
  // ===== RENDER ANALYSIS IN MODAL =====
  function renderAnalysis(ticker, history, analysis) {
    const { $modalBody } = state.cachedElements;
    const stockInfo = state.masterStockList.find(s => s.ticker === ticker) || { name: ticker, sector: 'Unknown' };
    
    // jQuery .html() to set modal content
    $modalBody.html(`
      <h2>${stockInfo.name} (${ticker})</h2>
      <p style="color:#666">${stockInfo.sector} | Source: ${history.source}</p>
      
      <div class="ai-prediction-box ${analysis.cssClass}">
        <h3>AI Verdict: ${analysis.signal}</h3>
        <p><strong>Trend:</strong> ${analysis.sentiment}</p>
        <p><strong>Volatility Risk:</strong> ${(analysis.volatility * 100).toFixed(2)}%</p>
      </div>
      
      <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9em;">
        <span>Current: <b>$${analysis.current.toFixed(2)}</b></span>
        <span>20-Day Avg: <b>$${analysis.sma20.toFixed(2)}</b></span>
      </div>
      
      <canvas id="chartCanvas" width="100%" height="250"></canvas>
    `);
    
    // Get canvas element - Chart.js needs raw DOM element
    const ctx = $('#chartCanvas')[0];
    
    // Create chart
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: history.dates,
        datasets: [{
          label: 'Price History',
          data: history.prices,
          borderColor: '#e8a9d6',
          backgroundColor: 'rgba(232, 169, 214, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 0
        },
        {
          label: 'SMA 20',
          data: calculateSMA(history.prices, 20),
          borderColor: '#b3cfff',
          borderWidth: 1,
          pointRadius: 0,
          borderDash: [5, 5]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        interaction: { intersect: false, mode: 'index' }
      }
    });
  }
  
  // ===== CLOSE MODAL (jQuery Animation) =====
  function closeModal() {
    // jQuery .fadeOut() for smooth animation
    state.cachedElements.$modal.fadeOut();
  }
  
  // ===== UTILITY FUNCTIONS =====
  function average(arr) {
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }
  
  function calculateVolatility(arr) {
    const mean = average(arr);
    const squaredDiffs = arr.map(x => Math.pow(x - mean, 2));
    const variance = average(squaredDiffs);
    return Math.sqrt(variance) / mean;
  }
  
  function calculateSMA(data, window) {
    let result = [];
    for (let i = 0; i < data.length; i++) {
      if (i < window - 1) {
        result.push(null);
      } else {
        const slice = data.slice(i - window + 1, i + 1);
        result.push(average(slice));
      }
    }
    return result;
  }
  
  // ===== PUBLIC API =====
  return {
    init: init
  };
})();

// ===== APP INITIALIZATION (jQuery Document Ready) =====
$(document).ready(function() {
  StockApp.init();
});
</script>
</body>
</html>
