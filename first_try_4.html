<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Live S&P 500 Estimator</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:'Montserrat',sans-serif;background:linear-gradient(120deg,#f8e3f0,#d1e3ff);color:#333;margin:0;min-height:100vh}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,#e8a9d6,#b3cfff);color:#4c3273;font-size:2em;font-weight:700;box-shadow:0 4px 12px #0000001a}
    .status-bar{background:#fff;text-align:center;padding:10px;font-size:.9em;border-bottom:1px solid #eee}
    .filters{display:flex;flex-wrap:wrap;gap:12px;padding:20px;justify-content:center;background:#fff2fa}
    .filter-group{display:flex;flex-direction:column;background:#fed6ff;border-radius:12px;padding:10px;flex:1;min-width:140px;max-width:200px}
    .filter-group label{font-weight:700;margin-bottom:5px;color:#4c3273;font-size:0.9em}
    select{border:2px solid #fff;border-radius:8px;padding:4px;background:#fff;height:100px;font-size:0.85em}
    .pink-btn{background:linear-gradient(90deg,#e8a9d6,#b3cfff);border:none;border-radius:20px;padding:12px 32px;margin:20px 0;color:#4c3273;font-weight:700;cursor:pointer;transition:.3s}
    .pink-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:2px 6px 20px #d1e3ff}
    .pink-btn:disabled{opacity:.6;cursor:not-allowed}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;max-width:1200px;margin:20px auto;padding:20px}
    .stock-card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 12px #0000000d;transition:.3s;position:relative}
    .stock-card:hover{transform:translateY(-5px);box-shadow:0 8px 24px #e8a9d666}
    .tags{display:flex;flex-wrap:wrap;gap:5px;margin:10px 0;font-size:0.75em}
    .tag{padding:3px 8px;border-radius:10px;font-weight:600}
    .tag-reg{background:#e0ecff;color:#0056b3}
    .tag-risk{background:#ffeaea;color:#d63384}
    .tag-eth{background:#eaffea;color:#28a745}
    .modal{display:none;position:fixed;inset:0;background:#00000099;justify-content:center;align-items:center;z-index:99}
    .modal-content{background:#fff;padding:30px;border-radius:20px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;position:relative}
    .close-btn{position:absolute;top:15px;right:20px;font-size:24px;cursor:pointer}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #e8a9d6;border-radius:50%;width:30px;height:30px;animation:s 1s linear infinite;margin:20px auto}
    @keyframes s{to{transform:rotate(360deg)}}
    .ai-box{background:#f0f7ff;border-left:4px solid #b3cfff;padding:15px;margin:15px 0;border-radius:0 8px 8px 0}
    .bull{border-left-color:#28a745;background:#eaffea}.bear{border-left-color:#dc3545;background:#ffeaea}
  </style>
</head>
<body>

<header>S&P 500 Live Estimator</header>
<div class="status-bar" id="status">Initializing...</div>

<div class="filters">
  <div class="filter-group"><label>Region</label><select id="reg" multiple></select></div>
  <div class="filter-group"><label>Risk Level</label><select id="rsk" multiple></select></div>
  <div class="filter-group"><label>Ethics/Future</label><select id="eth" multiple></select></div>
  <div class="filter-group"><label>Sector</label><select id="sec" multiple></select></div>
  <div class="filter-group"><label>Sub-Industry</label><select id="sub" multiple></select></div>
  
  <div class="filter-group" style="align-items:center;justify-content:center;background:none;max-width:150px">
    <button class="pink-btn" id="btn" disabled>Search</button>
    <small>Assets: <span id="cnt">0</span></small>
  </div>
</div>

<div class="cards" id="res"></div>

<div class="modal" id="mod"><div class="modal-content"><span class="close-btn">&times;</span><div id="modBody"></div></div></div>
<footer><center>Data enriched with Region, Risk & Ethics scoring. Not financial advice.</center></footer>

<script>
let stocks = [], chartInst = null;
const LIST_API = "https://raw.githubusercontent.com/hannahsch999/Stocks/main/sp500_complete_sample.json";

$(async () => {
  try {
    const raw = await $.getJSON(`https://corsproxy.io/?${encodeURIComponent(LIST_API)}`);
    
    // Map the JSON data with new Region, Risk, and Ethics fields
    stocks = raw.map(i => ({
      t: i.Symbol || i.Ticker, 
      n: i.Name || i.Security,
      s: i['GICS Sector'] || i.Sector || 'Other',
      ss: i['GICS Sub-Industry'] || i.subSector || 'Other',
      region: i.Region || 'North America',
      risk: i.Risk || 'Medium (Growth)',
      ethics: i.Ethics || 'Neutral'
    })).filter(s => s.t && s.s);

    $('#cnt').text(stocks.length);
    $('#status').html(`<span style="color:#28a745">System Ready (${stocks.length} assets)</span>`);
    $('#btn').prop('disabled', false);

    // Populate all filter dropdowns with unique values
    const populate = (id, data) => data.forEach(x => $(id).append(new Option(x, x)));
    
    populate('#reg', [...new Set(stocks.map(s => s.region))].sort());
    populate('#rsk', [...new Set(stocks.map(s => s.risk))].sort());
    populate('#eth', [...new Set(stocks.map(s => s.ethics))].sort());
    populate('#sec', [...new Set(stocks.map(s => s.s))].sort());
    
    updateSubSectors();
    $('#sec').on('change', updateSubSectors);

  } catch(e) { 
    $('#status').html(`<span style="color:#dc3545">Data Load Error: ${e.message}</span>`); 
    console.error(e);
  }
});

function updateSubSectors() {
  const selSec = $('#sec').val() || [];
  const rel = selSec.length ? stocks.filter(s => selSec.includes(s.s)) : stocks;
  const subs = [...new Set(rel.map(s => s.ss))].sort();
  
  $('#sub').empty();
  subs.forEach(s => $('#sub').append(new Option(s, s)));
}

$('#btn').click(() => {
  // Get selected filter values from all 5 dropdowns
  const fReg = $('#reg').val() || [];
  const fRsk = $('#rsk').val() || [];
  const fEth = $('#eth').val() || [];
  const fSec = $('#sec').val() || [];
  const fSub = $('#sub').val() || [];
  
  // Apply multiple filter conditions
  let m = stocks.filter(s => 
    (!fReg.length || fReg.includes(s.region)) &&
    (!fRsk.length || fRsk.includes(s.risk)) &&
    (!fEth.length || fEth.includes(s.ethics)) &&
    (!fSec.length || fSec.includes(s.s)) &&
    (!fSub.length || fSub.includes(s.ss))
  ).sort(() => .5 - Math.random()).slice(0, 20);

  $('#res').empty();
  if(!m.length) return $('#res').html('<p style="text-align:center;width:100%">No matches found.</p>');

  m.forEach(s => {
    $('#res').append(`
      <div class="stock-card">
        <h3>${s.n}</h3>
        <span style="background:#eee;padding:2px 6px;border-radius:4px;font-size:.9em;font-weight:bold">${s.t}</span>
        
        <div class="tags">
          <span class="tag tag-reg">${s.region}</span>
          <span class="tag tag-risk">${s.risk}</span>
          <span class="tag tag-eth">${s.ethics}</span>
        </div>

        <div style="margin:10px 0;font-size:.85em;color:#666">${s.s} &bull; ${s.ss}</div>
        <button class="pink-btn" style="width:100%;padding:10px;margin:10px 0 0" onclick="show('${s.t}')">Run Prediction</button>
      </div>`);
  });
});

async function show(t) {
  $('#mod').css('display','flex').fadeIn();
  $('#modBody').html('<div class="loader"></div><p style="text-align:center">Fetching market data...</p>');
  
  try {
    const symbol = t.replace('.','-');
    const url = `https://stooq.com/q/d/l/?s=${symbol}.US&i=d`;
    const csv = await $.get(`https://corsproxy.io/?${encodeURIComponent(url)}`);

    const lines = csv.trim().split('\n');
    if(lines.length < 2) throw new Error("No Data");
    
    const rows = lines.slice(1).map(l => l.split(',')).filter(r => r.length > 4);
    rows.sort((a,b) => a[0].localeCompare(b[0]));
    const recent = rows.slice(-50);
    
    const dates = recent.map(r => r[0]);
    const prices = recent.map(r => parseFloat(r[4]));

    const cur = prices.at(-1);
    const sma = prices.reduce((a,b)=>a+b,0) / prices.length;
    const sent = cur > sma ? "Bullish" : "Bearish";
    const cls = sent === "Bullish" ? "bull" : "bear";

    $('#modBody').html(`
      <h2>${t}</h2>
      <div class="ai-box ${cls}"><h3>Verdict: ${sent}</h3><p>Signal: ${sent === "Bullish" ? "Strong Buy" : "Sell"}</p></div>
      <canvas id="cvs"></canvas>
    `);

    if(chartInst) chartInst.destroy();
    chartInst = new Chart($('#cvs')[0], {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{ label:'Price', data:prices, borderColor:'#e8a9d6', fill:true, backgroundColor:'#e8a9d633', tension:0.3 }]
      }
    });

  } catch(e) { $('#modBody').html(`<h3 style="color:red">Error</h3><p>Failed to load data.</p><small>${e.message}</small>`); }
}

$('.close-btn, .modal').click(e => { if(e.target === e.currentTarget) $('#mod').fadeOut(); });
</script>
</body>
</html>
