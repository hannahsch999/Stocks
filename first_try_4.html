<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Live S&P 500 Estimator</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body { font-family:'Montserrat',sans-serif; background:linear-gradient(120deg,#f8e3f0 0%,#d1e3ff 100%); color:#333; margin:0; padding:0; min-height: 100vh; }
    header { padding:20px; text-align:center; background:linear-gradient(90deg,#e8a9d6 20%,#b3cfff 80%); color:#4c3273; font-size:2em; font-weight:700; letter-spacing:2px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    
    .status-bar { background: #fff; text-align: center; padding: 10px; font-size: 0.9em; color: #666; border-bottom: 1px solid #eee; }
    .status-ok { color: #28a745; font-weight: bold; }
    .status-err { color: #dc3545; font-weight: bold; }

    .filters { display:flex; flex-wrap:wrap; gap:14px; padding:24px; justify-content:center; background:#fff2fa; border-bottom:2px solid #f3c9e7; }
    .filter-group { display:flex; flex-direction:column; background:#fed6ff; border-radius:12px; padding:12px; min-width:180px; flex: 1; max-width: 250px; }
    .filter-group label { margin-bottom: 6px; font-weight: bold; color: #4c3273; }
    select { border: 2px solid #fff; border-radius: 8px; padding: 4px; background: #fff; color: #333; font-family: inherit; }
    
    .pink-btn { background:linear-gradient(90deg,#e8a9d6,#b3cfff); border:none; border-radius:20px; padding:12px 32px; margin:20px 0; color:#4c3273; font-weight:bold; cursor:pointer; box-shadow:2px 4px 16px #e8a9d6AA; transition:all .3s; font-size: 1em; }
    .pink-btn:hover { background:linear-gradient(100deg,#f3c9e7 20%,#b3d6ff 80%); transform: translateY(-2px); box-shadow:2px 6px 20px #d1e3ff; }
    .pink-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(100%); }

    .results { max-width:1100px; margin:26px auto; padding:20px; }
    .section-title { text-align: center; color: #4c3273; margin-bottom: 20px; }
    
    .cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:20px; margin-bottom:30px; }
    .stock-card { background:linear-gradient(135deg,#fff,#f8faff); border: 1px solid #e8e8e8; border-radius:16px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05); transition:all .3s; position: relative; overflow: hidden; }
    .stock-card:hover { box-shadow:0 8px 24px rgba(232, 169, 214, 0.4); transform: translateY(-5px); border-color: #e8a9d6; }
    .stock-card h3 { margin: 0 0 5px 0; color: #4c3273; font-size: 1.1em; }
    .stock-card .ticker { font-size: 0.9em; color: #888; background: #eee; padding: 2px 6px; border-radius: 4px; }
    .stock-meta { font-size: 0.85em; color: #666; margin: 10px 0; line-height: 1.4; }
    .stock-badge { display: inline-block; font-size: 0.75em; padding: 2px 8px; border-radius: 10px; margin-right: 5px; margin-bottom: 5px; }
    .badge-sector { background: #e0ecff; color: #4c3273; }
    
    footer { background:#f8e3f0; padding:20px; text-align:center; color:#807ca5; margin-top: auto; }
    
    .modal { display:none; position:fixed; z-index:2000; inset:0; width:100%; height:100%; justify-content:center; align-items:center; background:rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    .modal-content { background:#fff; padding:32px; border-radius:20px; width:90%; max-width:600px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size:24px; font-weight:bold; color:#e8a9d6; cursor:pointer; transition: color .2s; }
    .close-btn:hover { color: #b3cfff; }

    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #e8a9d6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .ai-prediction-box { background: #f0f7ff; border-left: 4px solid #b3cfff; padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0; }
    .prediction-bullish { border-left-color: #28a745; background: #eaffea; }
    .prediction-bearish { border-left-color: #dc3545; background: #ffeaea; }
  </style>
</head>
<body>

<header>AI S&P 500 Estimator</header>
<div class="status-bar" id="statusBar">Initializing System...</div>

<div class="filters">
  <div class="filter-group">
    <label for="sectorSelect">Sector</label>
    <select id="sectorSelect" multiple style="height:120px">
      <option disabled>Loading...</option>
    </select>
  </div>

  <div class="filter-group">
    <label for="subIndustrySelect">Sub-Industry</label>
    <select id="subIndustrySelect" multiple style="height:120px">
      <option disabled>Loading...</option>
    </select>
  </div>

  <div class="filter-group" style="justify-content: center; align-items: center;">
    <button class="pink-btn" id="getEstimatesBtn" onclick="runEstimates()" disabled>Initializing...</button>
    <small style="text-align:center; color:#666;">Assets: <span id="countDisplay">0</span></small>
  </div>
</div>

<div class="results" id="resultsArea" style="display:none">
  <h2 class="section-title">AI Selected Candidates</h2>
  <div class="cards" id="cardsContainer"></div>
</div>

<div class="modal" id="stockModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('stockModal')">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<footer>
  Data sourced from Public GitHub Repos via CORS Proxy. <br>
  Not financial advice. For educational purposes only.
</footer>

<script>
/* 
  =========================================
  PART 1: DATA SOURCING (Fixed URL)
  =========================================
*/
const PROXY_URL = "https://corsproxy.io/?"; 

// FIX: Use the 'raw' content URL, not the repository .git URL
// Assuming your file is named 'sp500.json' inside your repo. 
// If the file name is different, change 'sp500.json' to your actual filename.
const GITHUB_LIST_URL = "https://raw.githubusercontent.com/hannahsch999/Stocks/main/sp500_complete_sample.json";

// Fallback to the known working public list if yours fails
const FALLBACK_URL = "https://raw.githubusercontent.com/datasets/s-and-p-500-companies/main/data/constituents.json";

let masterStockList = [];

window.onload = async function() {
  const statusBar = document.getElementById('statusBar');
  const btn = document.getElementById('getEstimatesBtn');
  const countDisplay = document.getElementById('countDisplay');
  
  try {
    // --- FETCHING LOGIC ---
    console.log("Fetching data from:", GITHUB_LIST_URL);
    
    let rawData = [];
    
    try {
        // Try your custom repo first
        const response = await fetch(PROXY_URL + encodeURIComponent(GITHUB_LIST_URL));
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        rawData = await response.json();
    } catch (e) {
        console.warn("Custom repo failed, trying fallback...", e);
        // Use fallback if custom repo fails (e.g., typo in filename)
        const fallbackRes = await fetch(PROXY_URL + encodeURIComponent(FALLBACK_URL));
        if (!fallbackRes.ok) throw new Error("All data sources failed");
        rawData = await fallbackRes.json();
    }
    
    // --- MAPPING LOGIC ---
    masterStockList = rawData.map(item => ({
      // Handles different casing (Symbol vs symbol) automatically
      ticker: item.Symbol || item.symbol || item.Ticker,
      name: item.Name || item.name || item.Security,
      sector: item['GICS Sector'] || item.Sector || item.sector || 'Other',
      subsector: item['GICS Sub-Industry'] || item.subSector || item.subsector || 'Other'
    })).filter(s => s.ticker && s.sector);

    console.log(`Successfully loaded ${masterStockList.length} stocks.`);
    // -----------------------------------

    populateFilters(masterStockList);
    countDisplay.innerText = masterStockList.length;
    statusBar.innerHTML = `System Ready: <span class="status-ok">Connected (${masterStockList.length} assets)</span>`;
    btn.disabled = false;
    btn.innerText = "Get Stock Estimates";

  } catch (err) {
    console.error("Data Load Error:", err);
    statusBar.innerHTML = `System Error: <span class="status-err">${err.message}</span>`;
    btn.innerText = "Connection Failed";
  }
};

/* ================= FILTERS & UI ================= */
function populateFilters(stocks) {
  const sectorSet = new Set();
  const subSet = new Set();
  
  stocks.forEach(s => {
    if(s.sector) sectorSet.add(s.sector);
    if(s.subsector) subSet.add(s.subsector);
  });

  const sectorSelect = document.getElementById('sectorSelect');
  const subSelect = document.getElementById('subIndustrySelect');
  
  sectorSelect.innerHTML = '';
  subSelect.innerHTML = '';
  
  Array.from(sectorSet).sort().forEach(sect => {
    const opt = document.createElement('option');
    opt.value = sect; opt.innerText = sect; sectorSelect.appendChild(opt);
  });

  Array.from(subSet).sort().forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub; opt.innerText = sub; subSelect.appendChild(opt);
  });
}

function runEstimates() {
  const resultsArea = document.getElementById('resultsArea');
  const container = document.getElementById('cardsContainer');
  resultsArea.style.display = 'block';
  container.innerHTML = '<div class="loader"></div>';

  const selectedSectors = Array.from(document.getElementById('sectorSelect').selectedOptions).map(o => o.value);
  const selectedSubs = Array.from(document.getElementById('subIndustrySelect').selectedOptions).map(o => o.value);

  let matches = masterStockList.filter(stock => {
    const sectorMatch = selectedSectors.length === 0 || selectedSectors.includes(stock.sector);
    const subMatch = selectedSubs.length === 0 || selectedSubs.includes(stock.subsector);
    return sectorMatch && subMatch;
  });

  matches = matches.sort(() => 0.5 - Math.random()).slice(0, 12);

  container.innerHTML = '';
  if (matches.length === 0) {
    container.innerHTML = '<p style="text-align:center; width:100%">No assets found matching your criteria.</p>';
    return;
  }

  matches.forEach(stock => {
    const card = document.createElement('div');
    card.className = 'stock-card';
    card.innerHTML = `
      <h3>${stock.name}</h3>
      <span class="ticker">${stock.ticker}</span>
      <div class="stock-meta">
        <span class="stock-badge badge-sector">${stock.sector}</span><br>
        <small>${stock.subsector}</small>
      </div>
      <button class="pink-btn" style="width:100%; margin:10px 0 0 0; padding:10px;" onclick="analyzeStock('${stock.ticker}')">
        Run AI Prediction
      </button>
    `;
    container.appendChild(card);
  });
}

/* ================= PART 2: HISTORY & ANALYSIS ================= */

async function analyzeStock(ticker) {
  const modal = document.getElementById('stockModal');
  const body = document.getElementById('modalBody');
  
  modal.style.display = 'flex';
  body.innerHTML = `
    <div style="text-align:center">
      <div class="loader"></div>
      <p>Fetching market data for ${ticker}...</p>
    </div>
  `;

  try {
    const history = await fetchHistory(ticker);
    const analysis = performTechnicalAnalysis(history.prices);
    renderAnalysis(ticker, history, analysis);
  } catch (err) {
    body.innerHTML = `
      <h3 style="color:#dc3545">Analysis Failed</h3>
      <p>Could not retrieve data for ${ticker}.</p>
      <small>Error: ${err.message}</small>
    `;
  }
}

async function fetchHistory(ticker) {
  const symbol = ticker.replace('.', '-'); 
  const stooqUrl = `https://stooq.com/q/d/l/?s=${symbol}.US&i=d`;
  const proxyUrl = PROXY_URL + encodeURIComponent(stooqUrl);
  
  const res = await fetch(proxyUrl);
  if (!res.ok) throw new Error("Market data service unavailable");
  
  const csvText = await res.text();
  const lines = csvText.trim().split('\n');
  if(lines.length < 2) throw new Error("No data returned for symbol");
  
  const rows = lines.slice(1).map(l => l.split(',')).filter(r => r.length > 4);
  const validRows = rows.slice(0, 100).reverse(); 
  
  const dates = validRows.map(r => r[0]);
  const prices = validRows.map(r => parseFloat(r[4])); 

  if(prices.some(isNaN)) throw new Error("Corrupt data received");

  return { dates, prices, source: 'Stooq (Public)' };
}
//comment by cornelius

/* 
  =========================================
  PART 3: AI PREDICTION LOGIC
  =========================================
*/
function performTechnicalAnalysis(prices) {
  if (prices.length < 20) return { sentiment: "Neutral", confidence: "Low", details: "Insufficient data" };

  const current = prices[prices.length - 1];
  const sma20 = average(prices.slice(-20));
  const sma50 = prices.length >= 50 ? average(prices.slice(-50)) : sma20;
  
  let sentiment = "Neutral";
  let signal = "Hold";
  let cssClass = "";

  if (current > sma20 && sma20 > sma50) {
    sentiment = "Bullish";
    signal = "Strong Buy";
    cssClass = "prediction-bullish";
  } else if (current < sma20 && sma20 < sma50) {
    sentiment = "Bearish";
    signal = "Sell / Avoid";
    cssClass = "prediction-bearish";
  } else if (current > sma20) {
    sentiment = "Mild Bullish";
    signal = "Buy Dip";
    cssClass = "prediction-bullish";
  }

  const volatility = calculateVolatility(prices.slice(-14));

  return { current, sma20, sma50, sentiment, signal, cssClass, volatility };
}

function renderAnalysis(ticker, history, analysis) {
  const body = document.getElementById('modalBody');
  const stockInfo = masterStockList.find(s => s.ticker === ticker) || { name: ticker, sector: 'Unknown' };

  body.innerHTML = `
    <h2>${stockInfo.name} (${ticker})</h2>
    <p style="color:#666">${stockInfo.sector} | Source: ${history.source}</p>
    
    <div class="ai-prediction-box ${analysis.cssClass}">
      <h3>AI Verdict: ${analysis.signal}</h3>
      <p><strong>Trend:</strong> ${analysis.sentiment}</p>
      <p><strong>Volatility Risk:</strong> ${(analysis.volatility * 100).toFixed(2)}%</p>
    </div>

    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9em;">
      <span>Current: <b>$${analysis.current.toFixed(2)}</b></span>
      <span>20-Day Avg: <b>$${analysis.sma20.toFixed(2)}</b></span>
    </div>

    <canvas id="chartCanvas" width="100%" height="250"></canvas>
  `;

  new Chart(document.getElementById('chartCanvas'), {
    type: 'line',
    data: {
      labels: history.dates,
      datasets: [{
        label: 'Price History',
        data: history.prices,
        borderColor: '#e8a9d6',
        backgroundColor: 'rgba(232, 169, 214, 0.1)',
        fill: true,
        tension: 0.4,
        pointRadius: 0
      },
      {
        label: 'SMA 20',
        data: calculateSMA(history.prices, 20),
        borderColor: '#b3cfff',
        borderWidth: 1,
        pointRadius: 0,
        borderDash: [5, 5]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      interaction: { intersect: false, mode: 'index' }
    }
  });
}

/* ================= MATH HELPERS ================= */
function average(arr) { return arr.reduce((a,b) => a+b, 0) / arr.length; }

function calculateVolatility(arr) {
  const mean = average(arr);
  const squaredDiffs = arr.map(x => Math.pow(x - mean, 2));
  const variance = average(squaredDiffs);
  return Math.sqrt(variance) / mean; 
}

function calculateSMA(data, window) {
  let result = [];
  for (let i = 0; i < data.length; i++) {
    if (i < window - 1) {
      result.push(null); 
    } else {
      const slice = data.slice(i - window + 1, i + 1);
      result.push(average(slice));
    }
  }
  return result;
}

function closeModal(id) { document.getElementById(id).style.display = "none"; }
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) event.target.style.display = "none";
}
</script>
</body>
</html>
