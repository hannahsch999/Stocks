<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI Stock Price Estimator</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Avoids sourcemap 404 by using explicit minified UMD -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body { font-family:'Montserrat',sans-serif; background:linear-gradient(120deg,#f8e3f0 0%,#d1e3ff 100%); color:#333; margin:0; padding:0; }
    header { padding:20px; text-align:center; background:linear-gradient(90deg,#e8a9d6 20%,#b3cfff 80%); color:#4c3273; font-size:2em; font-weight:700; letter-spacing:2px; }
    .filters { display:flex; flex-wrap:wrap; gap:14px; padding:24px; justify-content:center; background:#fff2fa; border-bottom:2px solid #f3c9e7; }
    .filter-group { display:flex; flex-direction:column; background:#fed6ff; border-radius:12px; padding:12px; min-width:160px; }
    .pink-btn { background:linear-gradient(90deg,#e8a9d6,#b3cfff); border:none; border-radius:20px; padding:12px 32px; margin:20px 0; color:#4c3273; font-weight:bold; cursor:pointer; box-shadow:2px 4px 16px #e8a9d6AA; transition:background .3s; }
    .pink-btn:hover { background:linear-gradient(100deg,#f3c9e7 20%,#b3d6ff 80%); }
    .results { max-width:950px; margin:26px auto 0 auto; padding:20px; background:#fff6fa; border-radius:18px; box-shadow:0 6px 24px #f8e3f088; }
    .cards { display:flex; flex-wrap:wrap; gap:16px; justify-content:center; margin-bottom:24px; }
    .stock-card { background:linear-gradient(90deg,#fed6ff,#e0ecff); border-radius:16px; min-width:240px; padding:18px; box-shadow:0 2px 8px #e8a9d6AA; transition:box-shadow .4s; }
    .stock-card:hover { box-shadow:0 6px 24px #d1e3ffCC; }
    footer { background:#f8e3f0; padding:18px 0; text-align:center; color:#807ca5; }
    .modal { display:none; position:fixed; z-index:2000; inset:0; width:100%; height:100%; justify-content:center; align-items:center; background:#0006; }
    .modal-content { background:#fff; padding:32px 24px; border-radius:18px; max-width:580px; margin:auto; }
    .close-btn { float:right; font-size:20px; font-weight:bold; color:#e8a9d6; cursor:pointer; margin:-24px -12px 0 0; }
    .chart-section { margin-bottom:36px; }
    @media (max-width:900px){ .cards{ flex-direction:column; align-items:center; } }
  </style>
</head>
<body>
  <header>AI Stock Price Estimator</header>

  <div class="filters">
    <div class="filter-group">
      <label for="region">Region</label>
      <select id="region" multiple style="height:90px">
        <option value="USA">USA</option>
        <option value="Europe">Europe</option>
        <option value="China">China</option>
        <option value="Africa/Emerging">Africa/Emerging</option>
        <option value="Global">Global</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="sector">Sector</label>
      <select id="sector" multiple style="height:90px">
        <option value="Technology">Technology</option>
        <option value="Healthcare">Healthcare</option>
        <option value="Finance">Finance</option>
        <option value="Consumer Discretionary">Consumer Discretionary</option>
        <option value="Energy">Energy</option>
        <option value="Industrials">Industrials</option>
        <option value="Utilities">Utilities</option>
        <option value="Real Estate">Real Estate</option>
        <option value="Materials">Materials</option>
        <option value="Communication Services">Communication Services</option>
        <option value="Consumer Staples">Consumer Staples</option>
        <option value="ETF">ETF</option>
        <option value="Crypto">Crypto</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="subsector">Subsector</label>
      <select id="subsector" multiple style="height:90px">
        <option value="Software - Application">Software - Application</option>
        <option value="Semiconductors">Semiconductors</option>
        <option value="Pharmaceuticals">Pharmaceuticals</option>
        <option value="Banks">Banks</option>
        <option value="Insurance">Insurance</option>
        <option value="Oil & Gas">Oil & Gas</option>
        <option value="Utilities">Utilities</option>
        <option value="Retailing">Retailing</option>
        <option value="Health Care Equipment & Supplies">Health Care Equipment & Supplies</option>
        <option value="ETF">ETF</option>
        <option value="Crypto">Crypto</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="risk">Risk Level</label>
      <select id="risk" multiple style="height:90px">
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="volatility">Volatility / Return</label>
      <select id="volatility" multiple style="height:90px">
        <option value="Stable">Stable</option>
        <option value="Growth">Growth</option>
        <option value="Speculative">Speculative</option>
      </select>
    </div>

    <button class="pink-btn" onclick="getEstimates()">Get Stock Estimates</button>
  </div>

  <div class="results" id="results" style="display:none">
    <h2>Top Matching Assets</h2>
    <div class="cards" id="assetCards"></div>

    <div class="chart-section">
      <h3>Portfolio Trend (Average of Selection)</h3>
      <canvas id="portfolioChart" width="900" height="380"></canvas>
    </div>

    <button class="pink-btn" onclick="resetFilters()">Select Another Stock</button>
    <button class="pink-btn" onclick="showModal('aiModal')">About AI Predictions</button>
    <button class="pink-btn" onclick="showModal('helpModal')">Help</button>
  </div>

  <!-- Stock modal -->
  <div class="modal" id="stockModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('stockModal')">&times;</span>
      <div id="stockModalContent"></div>
    </div>
  </div>

  <!-- AI modal -->
  <div class="modal" id="aiModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('aiModal')">&times;</span>
      <h3>About AI Predictions</h3>
      <p>
        Predictions are based on historical price patterns and are for educational purposes only.
      </p>
    </div>
  </div>

  <!-- Help modal -->
  <div class="modal" id="helpModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('helpModal')">&times;</span>
      <h3>How to Use This Website & Investing Tips</h3>
      <ol>
        <li>Diversify your investments—don't put all your money in one stock.</li>
        <li>Understand your risk tolerance before investing.</li>
        <li>Large companies and ETFs are usually less volatile than individual stocks or crypto.</li>
        <li>Higher returns often mean higher risk.</li>
        <li>Use filters to find assets that fit your preferences.</li>
        <li>Check recent news that might affect performance.</li>
        <li>Past performance does not guarantee future results.</li>
        <li>Consider starting small and learning over time.</li>
        <li>Review your portfolio regularly.</li>
        <li>Never invest money you can't afford to lose.</li>
      </ol>
    </div>
  </div>

  <footer>Site for finance beginners — Investing can be fun and easy!</footer>

<script>
/* ========== CONFIG ========== */
const apiKey = 'KXV72OK74LH07YPF'; // FMP key (may 401 on free/invalid)
let allAssets = [];
let activeStockChart = null;

/* ========== POPULAR UNIVERSE (LOCAL) ========== */
/* Sectors/subsectors are simplified to power filters; region/risk/volatility prefilled */
const POPULAR_ASSETS = [
  // ETFs
  { ticker:'SPY', name:'SPDR S&P 500 ETF Trust', sector:'ETF', subsector:'ETF', industry:'ETF', region:'Global', risk:'Low', volatility:'Stable' },
  { ticker:'QQQ', name:'Invesco QQQ Trust', sector:'ETF', subsector:'ETF', industry:'ETF', region:'Global', risk:'Low', volatility:'Growth' },
  { ticker:'VTI', name:'Vanguard Total Stock Market ETF', sector:'ETF', subsector:'ETF', industry:'ETF', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'VOO', name:'Vanguard S&P 500 ETF', sector:'ETF', subsector:'ETF', industry:'ETF', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'IWM', name:'iShares Russell 2000 ETF', sector:'ETF', subsector:'ETF', industry:'ETF', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'EFA', name:'iShares MSCI EAFE ETF', sector:'ETF', subsector:'ETF', industry:'ETF', region:'Global', risk:'Low', volatility:'Stable' },
  { ticker:'EEM', name:'iShares MSCI Emerging Markets ETF', sector:'ETF', subsector:'ETF', industry:'ETF', region:'Global', risk:'Medium', volatility:'Growth' },
  { ticker:'XLK', name:'Technology Select Sector SPDR Fund', sector:'ETF', subsector:'ETF', industry:'ETF', region:'USA', risk:'Low', volatility:'Growth' },
  { ticker:'XLE', name:'Energy Select Sector SPDR Fund', sector:'ETF', subsector:'ETF', industry:'ETF', region:'USA', risk:'Low', volatility:'Growth' },
  { ticker:'XLV', name:'Health Care Select Sector SPDR Fund', sector:'ETF', subsector:'ETF', industry:'ETF', region:'USA', risk:'Low', volatility:'Stable' },

  // Mega-cap Tech
  { ticker:'AAPL', name:'Apple Inc.', sector:'Technology', subsector:'Technology Hardware, Storage & Peripherals', industry:'Technology', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'MSFT', name:'Microsoft Corporation', sector:'Technology', subsector:'Software - Infrastructure', industry:'Technology', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'NVDA', name:'NVIDIA Corporation', sector:'Technology', subsector:'Semiconductors', industry:'Technology', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'GOOGL', name:'Alphabet Inc. (Class A)', sector:'Communication Services', subsector:'Interactive Media & Services', industry:'Communication Services', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'AMZN', name:'Amazon.com, Inc.', sector:'Consumer Discretionary', subsector:'Internet & Direct Marketing Retail', industry:'Consumer Discretionary', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'META', name:'Meta Platforms, Inc.', sector:'Communication Services', subsector:'Interactive Media & Services', industry:'Communication Services', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'TSLA', name:'Tesla, Inc.', sector:'Consumer Discretionary', subsector:'Automobiles', industry:'Consumer Discretionary', region:'USA', risk:'High', volatility:'Growth' },

  // Other popular large caps
  { ticker:'BRK.B', name:'Berkshire Hathaway Inc. (B)', sector:'Finance', subsector:'Insurance', industry:'Finance', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'JPM', name:'JPMorgan Chase & Co.', sector:'Finance', subsector:'Banks', industry:'Finance', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'XOM', name:'Exxon Mobil Corporation', sector:'Energy', subsector:'Oil & Gas', industry:'Energy', region:'USA', risk:'Medium', volatility:'Growth' },
  { ticker:'PG', name:'Procter & Gamble Company', sector:'Consumer Staples', subsector:'Household Products', industry:'Consumer Staples', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'JNJ', name:'Johnson & Johnson', sector:'Healthcare', subsector:'Pharmaceuticals', industry:'Healthcare', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'V', name:'Visa Inc. (Class A)', sector:'Finance', subsector:'Consumer Finance', industry:'Finance', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'MA', name:'Mastercard Incorporated (Class A)', sector:'Finance', subsector:'Consumer Finance', industry:'Finance', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'HD', name:'Home Depot, Inc.', sector:'Consumer Discretionary', subsector:'Retailing', industry:'Consumer Discretionary', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'KO', name:'Coca-Cola Company', sector:'Consumer Staples', subsector:'Beverages', industry:'Consumer Staples', region:'USA', risk:'Low', volatility:'Stable' },
  { ticker:'PEP', name:'PepsiCo, Inc.', sector:'Consumer Staples', subsector:'Beverages', industry:'Consumer Staples', region:'USA', risk:'Low', volatility:'Stable' },

  // Crypto (spot proxies use USD pairs on many platforms; charts via fallback CSV not available, so we’ll try FMP first, else skip)
  { ticker:'BTCUSD', name:'Bitcoin', sector:'Crypto', subsector:'Crypto', industry:'Crypto', region:'Global', risk:'High', volatility:'Speculative' },
  { ticker:'ETHUSD', name:'Ethereum', sector:'Crypto', subsector:'Crypto', industry:'Crypto', region:'Global', risk:'High', volatility:'Speculative' },
];

/* ========== INITIAL LOAD ========== */
// Use local popular list immediately; optionally try to extend from FMP lists in background.
window.onload = async function() {
  const assetCards = document.getElementById('assetCards');
  assetCards.innerHTML = '<p>Loading assets...</p>';
  try {
    // Start with local universe to guarantee matches
    allAssets = POPULAR_ASSETS.slice();
    assetCards.innerHTML = '<p>Assets loaded. Use filters to find matches.</p>';
  } catch (e) {
    console.error(e);
    allAssets = POPULAR_ASSETS.slice();
    assetCards.innerHTML = '<p>Assets loaded locally.</p>';
  }
};

/* ========== FILTERING ========== */
async function getEstimates() {
  const regionVals = Array.from(document.getElementById('region').selectedOptions).map(o => o.value);
  const sectorVals = Array.from(document.getElementById('sector').selectedOptions).map(o => o.value);
  const subsectorVals = Array.from(document.getElementById('subsector').selectedOptions).map(o => o.value);
  const riskVals = Array.from(document.getElementById('risk').selectedOptions).map(o => o.value);
  const volVals = Array.from(document.getElementById('volatility').selectedOptions).map(o => o.value);

  const match = allAssets.filter(a =>
    (regionVals.length === 0 || regionVals.includes(a.region)) &&
    (sectorVals.length === 0 || sectorVals.includes(a.sector)) &&
    (subsectorVals.length === 0 || subsectorVals.includes(a.subsector)) &&
    (riskVals.length === 0 || riskVals.includes(a.risk)) &&
    (volVals.length === 0 || volVals.includes(a.volatility))
  );

  const topMatches = match.slice(0, 12);
  document.getElementById('results').style.display = 'block';
  const assetCards = document.getElementById('assetCards');
  assetCards.innerHTML = '';

  if (topMatches.length === 0) {
    assetCards.innerHTML = "<p>No assets match your criteria. Try broadening your search!</p>";
    drawPortfolioChart([]);
    return;
  }

  topMatches.forEach(asset => {
    const card = document.createElement('div');
    card.classList.add('stock-card');
    card.innerHTML = `
      <b>${asset.name} <span style="font-size:.8em;color:#4c3273;">(${asset.ticker})</span></b><br>
      <small>Sector: ${asset.sector}</small><br>
      <small>Subsector: ${asset.subsector}</small><br>
      <span>Risk: ${asset.risk} | ${asset.volatility}</span><br>
      <button class="pink-btn" style="margin:10px 0 0 0;padding:8px 18px;font-size:.9em;" onclick="showStock('${asset.ticker}')">See Performance</button>
    `;
    assetCards.appendChild(card);
  });

  await showStock(topMatches[0].ticker);
}

/* ========== PRICE HISTORY: FMP FIRST, THEN FREE CSV FALLBACK ========== */
// FMP endpoint (may return 401 or empty)
async function fetchFmpHistory(ticker) {
  const url = `https://financialmodelingprep.com/api/v3/historical-price-full/${encodeURIComponent(ticker)}?timeseries=60&apikey=${apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('FMP HTTP ' + res.status);
  const json = await res.json();
  const hist = Array.isArray(json.historical) ? json.historical : [];
  if (hist.length === 0) throw new Error('FMP empty');
  // oldest -> newest
  const records = hist.slice().reverse();
  const prices = records.map(d => Number(d.close)).filter(Number.isFinite);
  const labels = records.map(d => d.date || '');
  if (!prices.length) throw new Error('FMP malformed');
  return { labels, prices };
}

// Free CSV fallback via Stooq mirror (daily OHLC CSV). Map ticker to SYMBOL.US where applicable.
function mapToStooqSymbol(ticker) {
  // Stooq uses ".US" suffix for US stocks/ETFs, with BRK-B as BRK-B.US etc.
  // Crypto pairs generally not available; return null to skip.
  if (/USD$/i.test(ticker)) return null;
  // Replace slash and spaces
  let sym = ticker.replace(/\s+/g,'');
  return `${sym}.US`;
}

async function fetchCsv(url) {
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('CSV HTTP ' + res.status);
  const text = await res.text();
  return text;
}

function parseStooqCsv(text) {
  // CSV format: Date,Open,High,Low,Close,Volume
  const lines = text.trim().split('\n');
  if (lines.length <= 1) throw new Error('CSV empty');
  const rows = lines.slice(1) // skip header
    .map(l => l.split(','))
    .filter(cols => cols.length >= 5 && cols[0] && cols[4] && cols[4] !== '0');
  if (!rows.length) throw new Error('CSV no rows');
  // Use recent ~60 rows
  const recent = rows.slice(-60);
  const labels = recent.map(cols => cols[0]);
  const prices = recent.map(cols => Number(cols[4])).filter(Number.isFinite);
  if (!prices.length) throw new Error('CSV malformed');
  return { labels, prices };
}

async function fetchFallbackHistory(ticker) {
  const stooqSym = mapToStooqSymbol(ticker);
  if (!stooqSym) throw new Error('No CSV mapping');
  // Stooq CDN mirror via Stooq data on Stooq’s public domain is commonly mirrored by multiple CDNs;
  // here use Stooq direct HTTP(S) CSV endpoint pattern through cache:
  const url = `https://stooq.com/q/d/l/?s=${encodeURIComponent(stooqSym)}&i=d`;
  const text = await fetchCsv(url);
  return parseStooqCsv(text);
}

async function getHistory(ticker) {
  try {
    return await fetchFmpHistory(ticker);
  } catch (e) {
    // Try CSV fallback
    try {
      return await fetchFallbackHistory(ticker);
    } catch (e2) {
      throw e2;
    }
  }
}

/* ========== SHOW STOCK MODAL & CHART ========== */
async function showStock(ticker) {
  const assetInfo = allAssets.find(a => a.ticker === ticker);
  if (!assetInfo) return;

  const modalContent = document.getElementById('stockModalContent');
  modalContent.innerHTML = `<p>Loading price history for ${ticker}...</p>`;
  showModal('stockModal');

  try {
    const { labels, prices } = await getHistory(ticker);

    const latestPrice = prices[prices.length - 1];
    const simpleReturn = (latestPrice - prices[0]) / prices[0];
    const trend = simpleReturn > 0.05 ? "Strong upward trend"
                 : simpleReturn > 0 ? "Mild upward trend"
                 : "Stable or downtrend";

    modalContent.innerHTML = `
      <h3>${assetInfo.name} (${assetInfo.ticker})</h3>
      <p><b>Sector:</b> ${assetInfo.sector} | <b>Region:</b> ${assetInfo.region} | <b>Risk:</b> ${assetInfo.risk} (${assetInfo.volatility})</p>
      <p><b>Latest Price:</b> ${latestPrice.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
      <p><b>60-Day Trend Summary:</b> ${trend}</p>
      <canvas id="stockChart" width="430" height="200"></canvas>
    `;
    drawStockChart(labels, prices);
  } catch (err) {
    console.error('History fetch error:', err);
    modalContent.innerHTML = `<p style="color:red;">Could not load price history for ${ticker}.</p>`;
  }
}

function drawStockChart(labels, prices) {
  const ctx = document.getElementById('stockChart').getContext('2d');
  if (activeStockChart) activeStockChart.destroy();
  activeStockChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Price (USD)',
        data: prices,
        backgroundColor: '#e8a9d655',
        borderColor: '#e8a9d6',
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: { beginAtZero: false }
      }
    }
  });
}

/* ========== PORTFOLIO (placeholder) ========== */
function drawPortfolioChart(matches) {
  // Optional: fetch each selected symbol’s series and average.
}

/* ========== UI HELPERS ========== */
function resetFilters() {
  document.getElementById('results').style.display = 'none';
  document.querySelectorAll('.filters select').forEach(s => s.selectedIndex = -1);
}
function showModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>
